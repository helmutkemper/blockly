<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Toolbox</title>
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks_compressed.js"></script>
  <script src="../../msg/js/en.js"></script>
  <script src="../../blockly_compressed.js"></script>
  <script src="../../javascript_compressed.js"></script>
  <script src="../../msg/js/en.js"></script>
  <script src="minimap.js"></script>
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
    .minimap{
        position:absolute;
    }
    .mapDragger{
        cursor: move;
        fill:rgb(0,0,255);
        stroke-width:0.5;
        stroke:rgb(0,0,0);
        fill-opacity:0.1;
    }
  </style>
</head>
<body>

<table width="100%">
  <tr>
    <td>
      <div id="blocklyDiv" style="height: 480px; width: 900px;"></div>
    </td>
    <td>
      <div id="mapDiv" style="height: 480px; width: 200px;"></div>
    </td>
  </tr>
</table>
  <!--div id="blocklyDiv" style="height: 600px; width: 800px;"></div-->

  <xml xmlns="http://www.w3.org/1999/xhtml" id="toolbox" style="display: none;">
    <category name="api">
      <block type="inputquerystring1input"></block>
      <block type="typequerystring">
        <field name="type">integer</field>
        <field name="NAME">id</field>
      </block>
      <block type="typemodulenamestring">
        <field name="valueModuleNameString">module_name</field>
      </block>
    </category>
    <category name="query">
      <block type="fieldinput">
        <field name="fieldName">tag</field>
        <field name="nameType">fixValue</field>
      </block>
      <block type="typetagname">
        <field name="valueTagName">name</field>
      </block>
      <block type="typetaghighway">
        <field name="NAME">primary</field>
      </block>
      <block type="typetagplace">
        <field name="NAME">square</field>
      </block>
      <block type="typefield">
        <field name="id">id</field>
      </block>
      <block type="typefieldloc">
        <field name="lng">lng</field>
        <field name="lat">lat</field>
      </block>
      <block type="typefiedinput"></block>
      <block type="typequeryandinput"></block>
    </category>
    <category name="geo type">
      <block type="elementpoint"></block>
    </category>
    <category name="output">
      <block type="outputgeojson"></block>
      <block type="outputjson"></block>
    </category>
    <sep></sep>
    <category name="example point">
      <block type="inputquerystring1input">
        <value name="moduleNameString">
          <block type="typemodulenamestring">
            <field name="valueModuleNameString">point</field>
            <value name="NAME">
              <block type="typequerystring">
                <field name="type">integer</field>
                <field name="NAME">id</field>
              </block>
            </value>
          </block>
        </value>
        <statement name="NAME">
          <block type="typemethod"></block>
        </statement>
        <statement name="inputFieldInput">
          <block type="typefiedinput">
            <value name="NAME">
              <block type="typefield">
                <field name="id">id</field>
              </block>
            </value>
          </block>
        </statement>
        <statement name="typeElementInput">
          <block type="elementpoint"></block>
        </statement>
        <statement name="typeOutputInput">
          <block type="outputgeojson"></block>
        </statement>
      </block>
    </category>
  </xml>

  <xml xmlns="http://www.w3.org/1999/xhtml" id="workspaceBlocks" style="display:none">
    <variables></variables>
    <block type="inputquerystring1input" id="`47]SVt0Pj%H,PH,}ALI" x="13" y="12"></block>
  </xml>

  <script>
      /* TODO: Change toolbox XML ID if necessary. Can export toolbox XML from Workspace Factory. */
      var toolbox = document.getElementById("toolbox");

      var options = {
          toolbox : toolbox,
          collapse : true,
          comments : true,
          disable : true,
          maxBlocks : Infinity,
          trashcan : true,
          horizontalLayout : false,
          toolboxPosition : 'start',
          css : true,
          media: '../../media/',
          rtl : false,
          scrollbars : true,
          sounds : false,
          oneBasedIndex : true
      };

      /* Inject your workspace */
      var workspace = Blockly.inject('blocklyDiv', options);
      function showCode() {
          //var workspace = Blockly.JavaScript.getBlockById('blocklyDiv');
          // Generate JavaScript code and display it.
          Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
          var code = Blockly.JavaScript.workspaceToCode(workspace);
          alert(code);
      }

      /* Load Workspace Blocks from XML to workspace. Remove all code below if no blocks to load */

      /* TODO: Change workspace blocks XML ID if necessary. Can export workspace blocks XML from Workspace Factory. */
      Blockly.Blocks['typequerystring'] = {
          init: function() {
              this.appendValueInput("valueQueryString")
                  .setCheck(["typeQueryString", "typeModuleNameStringValueInput"])
                  .appendField("type:")
                  .appendField(new Blockly.FieldDropdown([["int","integer"], ["float","float point"], ["string","text"], ["nearby","near by coordinates"], ["regex","regular expression"]]), "type")
                  .appendField("name (letters only):")
                  .appendField(new Blockly.FieldTextInput("id"), "NAME")
                  .appendField("/");
              this.setInputsInline(false);
              this.setOutput(true, "typeQueryString");
              this.setColour(120);
              this.setTooltip("typeQueryString");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['inputquerystring1input'] = {
          init: function() {
              this.appendValueInput("moduleNameString")
                  .setCheck("typeModuleNameString")
                  .appendField("api.gosm.io/");
              this.appendStatementInput("NAME")
                  .setCheck(null)
                  .appendField("method:");
              this.appendStatementInput("inputFieldInput")
                  .setCheck("fieldInput")
                  .setAlign(Blockly.ALIGN_RIGHT)
                  .appendField("query:");
              this.appendStatementInput("typeElementInput")
                  .setCheck(null)
                  .setAlign(Blockly.ALIGN_RIGHT)
                  .appendField("element:");
              this.appendStatementInput("typeOutputInput")
                  .setCheck(null)
                  .setAlign(Blockly.ALIGN_RIGHT)
                  .appendField("output:");
              this.setColour(230);
              this.setTooltip("define query string");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['fieldinput'] = {
          init: function() {
              this.appendValueInput("NAME")
                  .setCheck(null)
                  .appendField("field:")
                  .appendField(new Blockly.FieldDropdown([["tag","tag"], ["id","id"], ["nearBy","nearBy"]]), "fieldName")
                  .appendField("type:")
                  .appendField(new Blockly.FieldDropdown([["fix value","fixValue"], ["query string value","queryStringValue"]]), "nameType");
              this.setPreviousStatement(true, null);
              this.setNextStatement(true, null);
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['typemodulenamestring'] = {
          init: function() {
              this.appendValueInput("NAME")
                  .setCheck(["typeQueryString", "typeModuleNameString"])
                  .appendField(new Blockly.FieldTextInput("module_name"), "valueModuleNameString")
                  .appendField("/");
              this.setOutput(true, ["typeModuleNameString", "typeQueryString"]);
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['typetagname'] = {
          init: function() {
              this.appendDummyInput()
                  .appendField("tag.name:")
                  .appendField(new Blockly.FieldTextInput("name"), "valueTagName");
              this.setOutput(true, "typeTagName");
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['typetaghighway'] = {
          init: function() {
              this.appendDummyInput()
                  .appendField("tag.highway:")
                  .appendField(new Blockly.FieldDropdown([["primary","primary"], ["secondary","secondary"], ["residential","residential"]]), "NAME");
              this.setOutput(true, "typeTag");
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['typetagplace'] = {
          init: function() {
              this.appendDummyInput()
                  .appendField("ta.place")
                  .appendField(new Blockly.FieldDropdown([["square","square"], ["neighbourhood","neighbourhood"], ["suburb","suburb"], ["farm","farm"], ["village","village"], ["locality","locality"], ["hamlet","hamlet"]]), "NAME");
              this.setOutput(true, "typeTag");
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['typefield'] = {
          init: function() {
              this.appendDummyInput()
                  .appendField("id:")
                  .appendField(new Blockly.FieldTextInput("id"), "id");
              this.setOutput(true, "typeField");
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['typefieldloc'] = {
          init: function() {
              this.appendDummyInput()
                  .appendField("lng:")
                  .appendField(new Blockly.FieldTextInput("lng"), "lng")
                  .appendField("lat:")
                  .appendField(new Blockly.FieldTextInput("lat"), "lat");
              this.setOutput(true, "typeField");
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['typefiedinput'] = {
          init: function() {
              this.appendValueInput("NAME")
                  .setCheck("typeField")
                  .appendField("query:");
              this.setInputsInline(false);
              this.setPreviousStatement(true, null);
              this.setNextStatement(true, null);
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['typequeryandinput'] = {
          init: function() {
              this.appendValueInput("NAME1")
                  .setCheck(["typeField", "typeTag"])
                  .appendField("$and:");
              this.appendValueInput("NAME2")
                  .setCheck(["typeField", "typeTag"]);
              this.setInputsInline(false);
              this.setPreviousStatement(true, null);
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['elementpoint'] = {
          init: function() {
              this.appendDummyInput()
                  .appendField("point");
              this.setPreviousStatement(true, null);
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['outputgeojson'] = {
          init: function() {
              this.appendDummyInput()
                  .appendField("geoJSon");
              this.setPreviousStatement(true, null);
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['outputjson'] = {
          init: function() {
              this.appendDummyInput()
                  .appendField("JSon");
              this.setPreviousStatement(true, null);
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      Blockly.Blocks['typemethod'] = {
          init: function() {
              this.appendDummyInput()
                  .appendField("_GET");
              this.setPreviousStatement(true, null);
              this.setColour(230);
              this.setTooltip("");
              this.setHelpUrl("");
          }
      };

      // Inject workspace for minimap.
      var minimapWorkspace = Blockly.inject('mapDiv',
          {media: '../../media/',
              readOnly: true,
              zoom:
                  {controls: false,
                      wheel: true,
                      startScale: 0.1, //you can change this accorting to your needs.
                      maxScale: 0.1,
                      minScale: 0.01
                  }});

      // Initilizing the minimap.
      Minimap.init(workspace,minimapWorkspace);


  </script>
<button onclick="showCode()">Show JavaScript</button>
</body>
</html>
